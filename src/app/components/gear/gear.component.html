<form class="gear-container" #optionsFOrm="ngForm">
    <mat-form-field class="option-container">
        <input matInput placeholder="Title" [(ngModel)]="modifiedOptions.title" (ngModelChange)="updateOnChange('title')" [name]="modifiedOptions._id + '_title'" required="false">
    </mat-form-field>

    <!-- MultiLayer Support-->
    <div *ngIf="modifiedOptions.isMultiLayerWidget">
        <mat-toolbar class="subheader tappable" color="primary" (click)="handleCreateLayer()">
            <mat-icon class="neon-icon-small">add_circle</mat-icon>
            <span class="spacer"></span>
            <div>Add Layer</div>
        </mat-toolbar>

        <div *ngFor="let layer of modifiedOptions.layers; let i = index;">
            <mat-toolbar class="subheader tappable" color="primary" (click)="toggleFilter(layer)">
                <span>{{ layer.title }}</span>
                <span class="spacer" *ngIf="modifiedOptions.layers.length > 1"></span>
                <mat-icon class="neon-icon-small" *ngIf="modifiedOptions.layers.length > 1" (click)="handleDeleteLayer(layer)">delete</mat-icon>
                <span class="spacer"></span>
                <mat-icon class="neon-icon-small">{{ getIconForFilter(layer) }}</mat-icon>
            </mat-toolbar>
            <div class="option-well" [hidden]="layerHidden.get(layer._id)">
                <mat-form-field class="option-container">
                    <input matInput placeholder="Title" [(ngModel)]="layer.title" (ngModelChange)="updateOnChange('title')" [name]="layer._id + '_title'" required="false">
                </mat-form-field>

                <mat-form-field class="option-container">
                    <mat-select placeholder="Database" [(ngModel)]="layer.database" required="true" [name]="layer._id + '_database'"
                        (ngModelChange)="handleChangeDatabase(layer)" [disabled]="layer.databases.length < 2">
                        <mat-option *ngFor="let database of layer.databases" [value]="database">{{ database.prettyName }}</mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field class="option-container">
                    <mat-select placeholder="Table" [(ngModel)]="layer.table" required="true" [name]="layer._id + '_table'"
                        (ngModelChange)="handleChangeTable(layer)" [disabled]="layer.tables.length < 2">
                        <mat-option *ngFor="let table of layer.tables" [value]="table">{{ table.prettyName }}</mat-option>
                    </mat-select>
                </mat-form-field>

                <app-options-list [options]=layer [fields]=layer.fields [bindingsList]=getLayerList(layer) [updateOnChange]=updateOnChange.bind(this) [index]=i>
                </app-options-list>
            </div>
        </div>
    </div>

    <mat-toolbar class="subheader" color="primary">
        <span>Required Config</span>
    </mat-toolbar>

    <!-- Non MultiLayer Support-->
    <div class="option-well">
        <mat-form-field *ngIf=!modifiedOptions.isMultiLayerWidget class="option-container">
            <mat-select placeholder="Database" [(ngModel)]="modifiedOptions.database" required="true" [name]="modifiedOptions._id + '_database'"
                (ngModelChange)="handleChangeDatabase(modifiedOptions)" [disabled]="modifiedOptions.databases.length < 2">
                <mat-option *ngFor="let database of modifiedOptions.databases" [value]="database">{{ database.prettyName }}</mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field *ngIf=!modifiedOptions.isMultiLayerWidget class="option-container">
            <mat-select placeholder="Table" [(ngModel)]="modifiedOptions.table" required="true" [name]="modifiedOptions._id + '_table'"
                (ngModelChange)="handleChangeTable(modifiedOptions)" [disabled]="modifiedOptions.tables.length < 2">
                <mat-option *ngFor="let table of modifiedOptions.tables" [value]="table">{{ table.prettyName }}</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Required Field Config-->
        <app-options-list [options]=modifiedOptions [fields]=modifiedOptions.fields [bindingsList]=requiredList [updateOnChange]=updateOnChange.bind(this)>
        </app-options-list>

        <!-- Required Non-Field Config-->
        <app-options-list [options]=modifiedOptions [fields]=modifiedOptions.fields [bindingsList]=requiredListNonField [updateOnChange]=updateOnChange.bind(this)>
        </app-options-list>
    </div>

    <mat-toolbar class="subheader tappable" (click)="toggleOptionalOptions()" color="primary">
        <span>Optional Config</span>
        <span class="spacer"></span>
        <mat-icon class="neon-icon-small">{{ getIconForOptions() }}</mat-icon>
    </mat-toolbar>

    <div class="option-well" [hidden]="collapseOptionalOptions">
        <!-- Optional Field Config-->
        <app-options-list [options]=modifiedOptions [fields]=modifiedOptions.fields [bindingsList]=optionalList [updateOnChange]=updateOnChange.bind(this)>
        </app-options-list>

        <!-- Optional Non-Field Config-->
        <app-options-list [options]=modifiedOptions [fields]=modifiedOptions.fields [bindingsList]=optionalListNonField [updateOnChange]=updateOnChange.bind(this)>
        </app-options-list>
    </div>

    <app-export-control [exportCallbacks]="exportCallbacks"></app-export-control>
</form>

<div class="button-footer" align="right">
    <button mat-raised-button class="neon-button-large" color="primary" (click)="resetOptionsAndClose()">
        Cancel
    </button>
    <button mat-raised-button class="neon-button-large" color="primary" [disabled]="!changeMade" (click)="handleApplyClick()">
        Apply Changes
    </button>
</div>
